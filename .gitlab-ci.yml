include:
    - .gitlab-ci.common.yml

stages:
    - install
    # - test
    # - lint
    - build
    - image
    # - deploy

install-job:
    extends: .webpack-stage
    stage: install
    tags:
        - nodejs
    image: node:20-alpine3.19
    script:
        - time pnpm install
    rules:
        - changes:
              - package.json
              - pnpm-lock.yaml
              - pnpm-workspace.yaml
              - packages/**/*

# sub package 构建部署处理
build-react18-webpack-job:
    stage: build
    extends: .webpack-stage
    image: node:20-alpine3.19
    tags:
        - nodejs
    script:
        - cd packages/react18-webpack
        - time pnpm install
        - time pnpm run build
        - mv dist ../../
    artifacts:
        paths:
            - dist
    rules:
        - changes:
              - packages/react18-webpack/**/*

build-react18-webpack-image-job:
    dependencies:
        - build-react18-webpack-job
    variables:
        SUB_PACKAGE: react18-webpack
    extends: .docker-build-stage
    rules:
        - changes:
              - packages/react18-webpack/**/*
